{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Morador — {{ condominio.nome }}</title>
    <link rel="icon" href="/img/logo.ico" type="image/x-icon">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/img/logo.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Plus Jakarta Sans', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: linear-gradient(-45deg, #3A89C9, #5ba3d9, #9CC4E4, #3A89C9);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .register-container {
            width: 100%;
            max-width: 440px;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-register {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(20px);
            border: none;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(58, 137, 201, 0.25);
            overflow: hidden;
        }

        .card-header-custom {
            background: linear-gradient(135deg, #3A89C9, #5ba3d9);
            padding: 1.8rem 1.5rem;
            text-align: center;
        }

        .condo-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 0.3rem 0.8rem;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
        }

        .card-header-custom h3 {
            color: white;
            font-weight: 800;
            margin-bottom: 0.2rem;
            font-size: 1.3rem;
        }

        .card-header-custom p {
            color: rgba(255,255,255,0.85);
            margin: 0;
            font-size: 0.82rem;
        }

        .card-body { padding: 1.5rem; }

        .form-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.78rem;
            margin-bottom: 0.3rem;
        }

        .form-control {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.65rem 0.8rem;
            font-size: 0.88rem;
            transition: all 0.2s;
        }

        .form-control:focus {
            border-color: #3A89C9;
            box-shadow: 0 0 0 3px rgba(58, 137, 201, 0.12);
        }

        .btn-register {
            background: linear-gradient(135deg, #3A89C9, #5ba3d9);
            border: none;
            border-radius: 10px;
            padding: 0.75rem;
            font-weight: 700;
            font-size: 0.95rem;
            color: white;
            width: 100%;
            transition: all 0.2s;
        }

        .btn-register:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(58, 137, 201, 0.35);
            color: white;
        }

        /* iOS WebKit: remove estilo nativo de botão */
        .btn-register,
        button[type="submit"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .section-divider {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin: 0.8rem 0;
        }

        .section-divider hr { flex: 1; border-color: #e5e7eb; }

        .section-divider span {
            font-size: 0.72rem;
            font-weight: 700;
            color: #3A89C9;
            white-space: nowrap;
        }

        .alert-custom {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            border-radius: 10px;
            padding: 0.6rem 0.8rem;
            font-size: 0.82rem;
        }

        .alert-success-custom {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            border-radius: 10px;
            padding: 0.6rem 0.8rem;
            font-size: 0.82rem;
        }

        .login-link {
            text-align: center;
            margin-top: 1rem;
        }

        .login-link a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .login-link a:hover { opacity: 1; }
    </style>
</head>
<body>
    <div class="register-container">
        <div class="card card-register">
            <div class="card-header-custom">
                <div class="condo-badge">
                    <i class="bi bi-building"></i> {{ condominio.nome }}
                </div>
                <h3>Cadastro de Morador</h3>
                <p>Crie sua conta para acessar o app</p>
            </div>

            <div class="card-body">
                {% if messages %}
                    {% for message in messages %}
                        <div class="{% if message.tags == 'success' %}alert-success-custom{% else %}alert-custom{% endif %} mb-3">
                            <i class="bi bi-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %} me-1"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-2">
                        <label class="form-label">Nome Completo *</label>
                        <input type="text" name="nome" class="form-control" placeholder="Seu nome completo" required value="{{ form_data.nome|default:'' }}">
                    </div>

                    <div class="row">
                        <div class="col-5 mb-2">
                            <label class="form-label">Bloco</label>
                            <input type="text" name="bloco" class="form-control" placeholder="A, B..." value="{{ form_data.bloco|default:'' }}">
                        </div>
                        <div class="col-7 mb-2">
                            <label class="form-label">Apartamento *</label>
                            <input type="text" name="apartamento" class="form-control" placeholder="101, 202..." required value="{{ form_data.apartamento|default:'' }}">
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Telefone</label>
                        <input type="text" name="telefone" class="form-control" placeholder="(00) 00000-0000" value="{{ form_data.telefone|default:'' }}">
                    </div>

                    <div class="mb-2">
                        <label class="form-label">E-mail</label>
                        <input type="email" name="email" class="form-control" placeholder="seu@email.com" value="{{ form_data.email|default:'' }}">
                    </div>

                    <div class="section-divider">
                        <hr><span><i class="bi bi-key"></i> DADOS DE ACESSO</span><hr>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Usuário (login) *</label>
                        <input type="text" name="username" class="form-control" placeholder="Ex: joao.silva" required value="{{ form_data.username|default:'' }}">
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Senha *</label>
                            <input type="password" name="password" class="form-control" placeholder="Mín. 6 caracteres" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Confirmar *</label>
                            <input type="password" name="password2" class="form-control" placeholder="Repita a senha" required>
                        </div>
                    </div>

                    <button type="submit" class="btn-register">
                        <i class="bi bi-person-plus me-2"></i>Criar Minha Conta
                    </button>
                </form>
            </div>
        </div>

        <div class="login-link">
            <a href="{% url 'login' %}">Já tem conta? <strong>Fazer login</strong></a>
        </div>

        <!-- Botão Instalar App (só aparece se PWA disponível) -->
        <div class="text-center mt-2">
            <button id="btnInstalarApp" onclick="instalarApp()" style="display: none;
                background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4);
                color: white; border-radius: 20px; padding: 0.4rem 1.2rem;
                font-weight: 700; font-size: 0.82rem; cursor: pointer;">
                <i class="bi bi-download me-1"></i>Instalar App
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // PWA: registrar service worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/sw.js').catch(() => {});
    }

    // PWA: capturar evento de instalação
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // Mostrar botão de instalar
        const installBtn = document.getElementById('btnInstalarApp');
        if (installBtn) installBtn.style.display = '';
    });

    function instalarApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => {
                deferredPrompt = null;
                const installBtn = document.getElementById('btnInstalarApp');
                if (installBtn) installBtn.style.display = 'none';
            });
        }
    }

    // iOS WebKit: intercepta o envio do formulário para tratar erros de CSRF
    (function() {
        var form = document.querySelector('form[method="post"]');
        if (!form) return;

        // Adiciona autocomplete para compatibilidade iOS
        form.setAttribute('autocomplete', 'on');

        form.addEventListener('submit', function(e) {
            var btn = form.querySelector('button[type="submit"]');
            var csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');

            // Se não tem token CSRF, tentar buscar da página novamente
            if (!csrfInput || !csrfInput.value) {
                e.preventDefault();
                alert('Erro de segurança. Por favor, recarregue a página e tente novamente.');
                location.reload();
                return;
            }

            // Desabilita botão para evitar duplo clique
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Criando conta...';
            }
        });
    })();
    </script>
</body>
</html>
