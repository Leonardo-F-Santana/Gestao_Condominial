{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìú Hist√≥rico de Encomendas Entregues</h2>
        <a href="{% url 'home' %}?aba=encomendas" class="btn btn-secondary">‚¨ÖÔ∏è Voltar</a>
    </div>

    <div class="card shadow-sm mb-4 bg-light">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Buscar</label>
                    <input type="text" name="busca" class="form-control" placeholder="Morador, Apto ou Quem retirou..." value="{{ busca|default:'' }}">
                </div>
                
                <div class="col-md-3">
                    <label class="form-label fw-bold">De:</label>
                    <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio|default:'' }}">
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold">At√©:</label>
                    <input type="date" name="data_fim" class="form-control" value="{{ data_fim|default:'' }}">
                </div>

                <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                    <a href="{% url 'historico_encomendas' %}" class="btn btn-outline-secondary" title="Limpar Filtros">‚ùå</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-lg">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Entrega</th>
                        <th>Morador</th>
                        <th>Volume</th>
                        <th>Retirado Por</th>
                        <th>Porteiro</th>
                    </tr>
                </thead>
                <tbody>
                    {% for enc in encomendas %}
                        <tr>
                            <td>
                                <strong>{{ enc.data_entrega|date:"d/m/Y" }}</strong>
                                <br><small class="text-muted">{{ enc.data_entrega|date:"H:i" }}</small>
                            </td>
                            <td>
                                {{ enc.morador.nome }}
                                <br><small class="text-primary fw-bold">{{ enc.morador.bloco }} - {{ enc.morador.apartamento }}</small>
                            </td>
                            <td>{{ enc.volume }}</td>
                            <td>
                                <span class="badge bg-success">‚úî {{ enc.quem_retirou }}</span>
                                {% if enc.documento_retirada %}
                                    <br><small class="text-muted">Doc: {{ enc.documento_retirada }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">
                                    Entrada: {{ enc.porteiro_cadastro.username|default:"-" }}
                                    <br>Sa√≠da: {{ enc.porteiro_entrega.username|default:"-" }}
                                </small>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="text-center p-5 text-muted">
                                <h4>Nenhum registro encontrado.</h4>
                                <p>Tente mudar os filtros de busca.</p>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if encomendas.has_other_pages %}
        <div class="card-footer bg-white d-flex justify-content-center pt-3">
            <nav>
                <ul class="pagination">
                    {% if encomendas.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ encomendas.previous_page_number }}&busca={{ busca }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">Anterior</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">P√°gina {{ encomendas.number }} de {{ encomendas.paginator.num_pages }}</span>
                    </li>

                    {% if encomendas.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ encomendas.next_page_number }}&busca={{ busca }}&data_inicio={{ data_inicio }}&data_fim={{ data_fim }}">Pr√≥xima</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">Pr√≥xima</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}